## ⚠️ 重要な注意事項

このプロジェクトは **ウェブアプリのセキュリティ実験用のコンテンツ** です。学習と検証を目的として、あえて脆弱性を含む設計となっています。

- このウェブアプリを公開サーバーやインターネット上でホストしないでください。
- 自分以外がアクセス可能な環境にデプロイしないでください。
- ローカル環境（localhost）でのみ実行してください。

このコードには意図的に組み込まれたセキュリティの脆弱性💀があります。セキュティ学習用の教材としてのみ利用してください。

## セットアップ手順

### 1. リポジトリのクローン

```
git clone https://github.com/TakeshiWada1980/web-sec-playground-1.git
cd web-sec-playground-1
```

上記でクローンすると、カレントフォルダのなかに `web-sec-playground-1` というフォルダが新規作成されて展開されます。別名にしたいときは、たとえば `hoge` というフォルダにクローンしたいときは、次のようにしてください。

```
git clone https://github.com/TakeshiWada1980/web-sec-playground-1.git hoge
cd hoge
```

### 2. 依存関係のインストール

```bash
npm i
```

### 3. 環境変数の設定ファイル (.env) の作成

プロジェクトのルートフォルダに `.env` (環境変数の設定ファイル) を新規作成して以下の内容を記述してください。

```
DATABASE_URL="file:./app.db"
JWT_SECRET=ABCDEFG123456789UVWXYZ
```

- `JWT_SECRET` は認証処理に必要な秘密キーです。安全性を確保するため、適当なランダムな英数字を用いた **16文字以上の文字列** に置き換えてください。文字数が不十分だと、動作時にエラーとなる可能性があります。


### 4. データベースの初期化

```bash
npx prisma db push
npx prisma generate
npx prisma db seed
```

### 5. 開発サーバの起動

```bash
npm run dev
```

### 6. ビルドと実行

```bash
npm run build
npm run start
```

- データベースの状態確認

```bash
npx prisma studio
```

##ワンタイムパスワードによる2段階認証

初回セットアップ（ユーザー登録）

/signup などの専用画面からユーザー登録

登録成功時に TOTP用QRコード が生成され、画面に表示

QRコードをスマホアプリで読み取ることで、2FAが有効化

この時点で、ユーザー情報は以下のように保存されます：

email / password（ハッシュ化済み）

twoFactorSecretEnc（暗号化されたTOTPシークレット）

バックアップコード（必要に応じて発行）

ログインフロー

ユーザーはまず メールアドレス・パスワード を入力

サーバで認証成功すると 2FA待機状態（Cookie p2f） を発行

フロントは /2fa/login に遷移

ユーザーは ワンタイムパスワード（6桁） を入力

サーバでTOTPを検証、またはバックアップコードで検証

認証成功後、セッションまたはJWTを発行して完全ログイン完了

2FAの仕組み

TOTP (Time-based One-Time Password) を使用

サーバ側でユーザーごとの秘密鍵を暗号化して保存

フロントはQRコードを表示し、ユーザーはGoogle Authenticatorなどで登録

ワンタイムパスワードは30秒ごとに更新される

バックアップコードも登録可能で、使い捨て方式

今後の展望・拡張案

パスワードリセット機能

メールリンクからパスワード変更

2FA再設定も可能に

2FAオプション管理

ユーザーが2FAを無効化／再設定できる画面

セッション管理の強化

同時ログインデバイス制御

ログアウト処理の一括管理

UI改善

QRコード読み取りチュートリアル

2FA未完了時のアラート表示

バックアップコード管理

追加発行

使用履歴表示

CSVでのダウンロード・印刷対応

使い方例
初回セットアップ

/signup にアクセス

ユーザー名・パスワードを入力

QRコードをスマホで読み取る

2FAが有効化される

ログイン

/login にアクセス

メールアドレス・パスワードを入力

2FA入力画面に遷移

ワンタイムパスワードを入力

ログイン完了

🔹 補足

フロントは Next.js 13 App Router を使用

サーバサイドでの2FA待機管理 は Cookie（p2f）で行い、
ログイン後すぐにセッションを発行せず、2FA完了後にセッション／JWTを発行

バックアップコード は安全にハッシュ化して保存され、使い捨て方式で検証